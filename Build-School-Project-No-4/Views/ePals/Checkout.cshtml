@model CheckoutViewModel
@{
    ViewBag.Title = "Checkout";
    //var ck = Model.Checkout;
    var startTime = Model.StartTime.ToString("MM/dd/yyyy hh:mm tt");
}
@section topCSS{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link href="~/Assets/css/checkout.css" rel="stylesheet" />
}

<div class="container">
    @using (Html.BeginForm())
    {
        @Html.AntiForgeryToken()
        <div class="checkout-container">
            <div class="row">
                <div class="col-12">
                    <h1 class="checkout-header">Checkout</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="cart-summary">
                        <div class="order-info">
                            <div class="order-id greyish">OrderID:</div>
                            <div class="order-id-value greyish">@Model.OrderConfirmation</div>
                        </div>
                        <hr>

                        <div class="game-info">
                            <div class="game-play">Play @Model.GameName with @Model.PlayerName</div>
                            <img src="@Model.PlayerPic" />
                        </div>

                        <div class="start-info">
                            <div class="greyish">Start Time:</div>
                            <div class="start-time desc">@startTime</div>
                        </div>

                        <div class="unit-price">
                            <div class="greyish">Unit Price:</div>
                            <div class="price desc">$@Model.UnitPrice.ToString("N2")/G</div>
                        </div>

                        <div class="rounds-info">
                            <div class="greyish">Rounds:</div>
                            <div class="rounds-value desc">@Model.Rounds</div>
                        </div>
                        <hr>
                        <div class="subtotal-info">
                            <div class="greyish">Subtotal:</div>
                            <div class="subtotal desc">$@((Model.Rounds * Model.UnitPrice).ToString("N2"))</div>
                        </div>
                        <div class="promotion">
                            <div class="greyish">ePal Promotion: </div>
                            <div class="discount desc"></div>
                        </div>
                        <hr>
                        <div class="final-price-div">
                            <div class="greyish">Final Price:</div>
                            <div>@Model.Rounds Round(s) total</div>
                            <div class="price-total price-summary">$@((Model.Rounds * Model.UnitPrice).ToString("N2"))</div>
                        </div>

                    </div>
                    <div class="timer-div greyish">
                        Please complete the payment within <span class="time-left" id="counter"></span><span class="testtest"></span>, otherwise the order will be cancelled automatically

                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-8">
                    <div class="payment">

                        <div class="payment-label">
                            <label class="payment-check-label" for="paymentRadio">
                                <span class="straighten">
                                    <input class="form-check-input" type="radio" name="payType" id="paymentRadio" value="paypal" checked>
                                    <span>Paypal</span>
                                </span>
                                <span class="paypal-img">
                                    <img src="~/Assets/images/checkout/paypal.png" />
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="payment">
                        <div class="payment-label">
                            <label class="payment-check-label" for="linePay">
                                <input class="form-check-input" type="radio" name="payType" id="linePay" value="linePay">
                                <span>LinePay</span>
                                <span class="linepay-img">
                                    <img src="~/Assets/images/checkout/linepay.png" />
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="total-div">
                        <div class="total-price">Total Price</div>
                        <div class="price-total price-total-txt">$@((Model.Rounds * Model.UnitPrice).ToString("N2"))</div>
                        <div class="checkout-btn-div">
                            <button class="checkout-btn" type="submit" id="checkoutButton">Checkout</button>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    }

    <div class="modal " tabindex="-1" id="timeoutModal" >
        <div class="modal-dialog .modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                <p>Cart Session Has Timed Out</p>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick=RedirectToProductPage()></button>
                </div>
                <div class="modal-body">
                    <p>Please try placing your order again :(</p>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"  onclick=RedirectToProductPage()>Okay</button>
                </div>
            </div>
        </div>
    </div>

</div>


@section endJS{
    @{
        var unixDateTime = Model.OrderDateTime;
    }

<script>

let timer = document.getElementById('counter')
    let dateTimeNow = new Date();
    let timeNow = dateTimeNow.getTime();
    let orderTime = new Date("@startTime");

    const utcStart = new Date("@unixDateTime").getTime();
    const utcEnd = utcStart + 900000;
    var now = new Date();
    const utcNow = new Date(now.getTime() + now.getTimezoneOffset() * 60000).getTime();
    let remainingTime = (utcEnd - utcNow);
    let setTime;


    let timeLeft = (remainingTime) / 1000;
    CheckTime();
    let min, sec;
    min = Math.floor(timeLeft / 60);
    sec = Math.floor(timeLeft % 60);

    function countdown() {

        sec--
        timeLeft--;
        if (sec < 0 && min > 0) {
            sec = 59;
            min--
            timer.innerText = `${min}m ${sec}s`;
        } else if (sec > 0 && min > 0) {
            timer.innerText = `${min}m ${sec}s`;
        } else if (sec < 0 && min == 0) {
            CheckTime();

            clearInterval(setTime);
            return;
        } else {
            timer.innerText = `${min}m ${sec}s`;
        }
    }
    let modalTest = document.getElementById('testmodal');

    function CheckTime() {
        if (timeLeft < 0) {
            PaymentTimeout();
        }
        else { setTime = setInterval(countdown, 1000)};
    }

    function PaymentTimeout() {
        timer.innerText = "-----";
        var timeoutModal = new bootstrap.Modal(document.getElementById('timeoutModal'), { backdrop: 'static' });
        timeoutModal.toggle();
        var checkoutBtn = document.getElementById('checkoutButton');
        checkoutBtn.setAttribute("disabled", "disabled");
    }

    function RedirectToProductPage() {
        window.location = `/epals/detail/@Model.ProductId`;
    }
</script>
}